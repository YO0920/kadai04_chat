<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css">
    <title>Chat App</title>
</head>

<body>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->

    <div>
        <div><span class="star">*</span>åå‰ï¼š<input type="text" id="uname"></div>
        <div>
            <textarea id="text" cols="30" rows="10"></textarea>
            <div class="send-button">
                <button id="send">é€ä¿¡</button>
            </div>
        </div>
        <div id="output" style="overflow: auto; height: 300px;"></div>
    </div>
    <!--/ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºç”»é¢ -->



    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- JQuery -->


    <!--** ä»¥ä¸‹Firebase **-->
    <script type="module">
        import firebaseConfig from "./js/firebaseApikey.js";
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, update, onChildAdded, remove, onChildChanged, onChildRemoved }
        from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        console.log(firebaseConfig);


        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        //Firebase APIã¯åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«

        // Initialize Firebase
        const app = initializeApp(firebaseConfig); //Firebaseã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
        const db = getDatabase(app); //ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
        const dbRef = ref(db, "chat"); //ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®chatã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹

        //æŠ•ç¨¿æ™‚é–“å–å¾—ã™ã‚‹é–¢æ•°
        function post_time() {
            let month = new Date().getMonth() + 1;
            let date = new Date().getDate();
            let hour = new Date().getHours().toString().padStart(2, '0'); //æ™‚åˆ»äºŒæ¡è¡¨ç¤ºï¼ˆå‚ç…§ï¼šhttps://qiita.com/Naoki_kkc/items/2a29287834c453d23ecfï¼‰
            let minute = new Date().getMinutes().toString().padStart(2, '0');
            return `${month}/${date} ${hour}:${minute}`;
        }


        //é€ä¿¡
        $("#send").on("click", function () {
            //åå‰æœªå…¥åŠ›ã®å ´åˆã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™(ã“ã®ã‚µã‚¤ãƒˆå‚ç…§ï¼šhttps://qiita.com/ntm718/items/c1c105099783e09504f0)
            let error;
            let value = $("#uname").val();
            if (value == "" || !value.match(/[^\s\t]/)) {
                error = true;
            }

            if (error) {
                alert("åå‰ã¯å¿…é ˆã§ã™");
                return false;

            } else {

                const msg = {
                    uname: $("#uname").val(),
                    time: post_time(),
                    text: $("#text").val()
                }
                const newPostRef = push(dbRef); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã‚’ç”Ÿæˆ
                set(newPostRef, msg); //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€ç·’ã«æŠ•ã’ã‚‹
            }
            $("#uname").val(""); //é€ä¿¡ã—ãŸã‚‰åå‰ã®å…¥åŠ›æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆãŒè‡ªå‹•ã§æ¶ˆãˆã‚‹
            $("#text").val(""); //é€ä¿¡ã—ãŸã‚‰æœ¬æ–‡ã®å…¥åŠ›æ¬„ã®ãƒ†ã‚­ã‚¹ãƒˆãŒè‡ªå‹•ã§æ¶ˆãˆã‚‹
        });

        //å—ä¿¡
        onChildAdded(dbRef, function (data) {
            const msg = data.val();
            const key = data.key; //ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼ã€å‰Šé™¤ãƒ»æ›´æ–°ã«å¿…é ˆï¼
            let h = '<p id=" ' + key + ' ">';
            h += '<p class="name_bold">'+msg.uname+'</p>'; //è¡¨ç¤ºã•ã‚Œã‚‹ã¨ãã«åå‰ã ã‘å¤ªå­—ã«ã™ã‚‹ãŸã‚ã«pã‚¿ã‚°ã§æ‹¬ã£ãŸ
            h += "ã€€";
            h += msg.time; //åå‰ã®éš£ã«é€ä¿¡æ™‚åˆ»ã‚’è¡¨ç¤º
            h += '<br>';
            h += "ã€€";
            h += '<span contentEditable="true" id="' + key + '_update">' + msg.text + '</span>'; //ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§æœ¬æ–‡å¤‰æ›´ã§ãã‚‹
            h += '<span class="remove" data-key="' + key + '">ğŸš®</span>'
            h += '<span class="update" data-key="' + key + '">ğŸ†™</span>'
            h += '</p>';
            $("#output").prepend(h); //#outputã®ä¸Šã«è¿½åŠ 
            $(".name_bold").css("font-weight", "bold"); //åå‰ã‚’å¤ªå­—
        });

        //å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click", ".remove", function () {
            const key = $(this).attr("data-key");
            const remove_item = ref(db, "chat/" + key);
            remove(remove_item); //Firebaseãƒ‡ãƒ¼ã‚¿å‰Šé™¤é–¢æ•°
        });

        //æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
        $("#output").on("click", ".update", function () {
            const key = $(this).attr("data-key");
            update(ref(db, "chat/" + key), {
                text: $("#" + key + '_update').html()
            });
        });

        //å‰Šé™¤å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        onChildRemoved(dbRef, (data) => {
            $("#" + data.key).remove(); //DOMæ“ä½œé–¢æ•°ï¼ˆå¯¾è±¡ã‚’å‰Šé™¤ï¼‰
        });

        //æ›´æ–°å‡¦ç†ãŒFirebaseå´ã§å®Ÿè¡Œã•ã‚ŒãŸã‚‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        onChildChanged(dbRef, (data) => {
            $("#" + data.key + '_update').html(data.val().text);
            $("#" + data.key + '_update').fadeOut(800).fadeIn(800);
        });


    </script>
</body>

</html>